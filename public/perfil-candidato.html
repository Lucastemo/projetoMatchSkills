<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Match Skills</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="notification-container"></div>
    <a id="topo"></a>
    <nav class="navbar">
        <div class="container">
            <a href="/home"><img src="img/logomatchskills1.svg" alt="Match Skills Logo" class="logo"></a>
            <ul class="nav-links">
                <li><a href="/home">Início</a></li>
                <li><a href="/buscar-vagas">Buscar Vagas</a></li>
                <li><a href="/buscar-empresas">Buscar Empresas</a></li>
                <li><a href="/sobre-nos">Sobre Nós</a></li>
            </ul>
            <!-- Estado Padrão: Não Logado -->
            <div id="nav-user-default" class="nav-user bigger-column-gap" style="display: none;">
                <a href="/login" class="btn btn-secondary">Login</a>
                <a href="/cadastro" class="btn btn-primary">Cadastre-se</a>
            </div>
            <!-- Estado Logado (escondido por padrão) -->
            <div id="nav-user-logged" class="nav-user">
                <a href="/perfil"><img src="/img/fotos-perfil/candidato-sem-foto.png" alt="Foto de Perfil" class="profile-pic"></a>
                <a href="#" class="logout-btn">Sair</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="profile-layout">
                <aside class="profile-sidebar">
                    <div class="profile-pic-container">
                        <img src="/img/fotos-perfil/candidato-sem-foto.png" alt="Foto de Perfil" class="main-profile-pic" id="profilePic">
                        <div class="edit-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </div>
                        <input type="file" id="profilePicInput" accept="image/*" style="display: none;">

                    </div>
                    <h2 id="profileName">Nome do Candidato</h2>
                    <p class="join-date" id="joinDate">Membro desde...</p>
                    <a href="#" class="btn btn-primary" id="editButton">Modificar Dados</a>
                    <a href="#" class="btn btn-premium btn-secondary" id="becomePremiumBtn" data-modal-target="#premiumModalCandidato" style="display: none;">Tornar-se Premium</a>
                    <a href="#" class="btn btn-danger" id="cancelPremiumBtn" style="display: none;">Deixar de Ser Premium</a>
                </aside>

                <section class="profile-content">
                    <div class="card no-translateY">
                        <h3>Minhas Informações</h3>
                        <form id="profileForm">
                            <div class="profile-grid-two">
                                <div class="form-group">
                                    <label for="nome">Nome Completo</label>
                                    <input type="text" id="nome" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="cpf">CPF</label>
                                    <input type="text" id="cpf" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">E-mail</label>
                                <input type="email" id="email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="curriculo">Currículo (PDF)</label>
                                <div id="curriculoDisplay">
                                    <a href="#" id="curriculoLink" target="_blank" class="link-styled">Ver currículo atual</a>
                                    <input type="file" id="curriculo" accept=".pdf" style="display: none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="descricao">Descrição Pessoal</label>
                                <textarea id="descricao" readonly rows="4"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="skills">Habilidades e Competências</label>
                                <div class="multi-select-container">
                                    <input type="text" id="skills" class="multi-select-input" placeholder="Digite para buscar uma habilidade...">
                                    <div class="suggestions-dropdown">
                                        </div>
                                    <div class="selected-skills">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <a href="/home"><img src="img/logomatchskills1.svg" alt="Match Skills Logo" class="logo"></a>
            <ul class="footer-links">
                <li><a href="/sobre-nos">Sobre Nós</a></li>
                <li><a id="footer-profile-link" href="/perfil">Meu Perfil</a></li>
                <li><a href="/home">Início</a></li>
                <li><a href="#topo">Voltar ao Topo</a></li>
            </ul>
        </div>
    </footer>
    
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="confirmation-backdrop" id="confirmationBackdrop"></div>
    <div class="confirmation-dialog" id="confirmationDialog">
        <p class="confirmation-message">Você tem certeza?</p>
        <div class="confirmation-buttons">
            <button class="btn btn-secondary btn-cancel">Cancelar</button>
            <button class="btn btn-danger btn-confirm">Confirmar</button>
        </div>
    </div>

    <!-- Modal Premium Candidato -->
    <div class="modal" id="premiumModalCandidato">
        <div class="modal-header">
            <h3>✨ Torne-se Premium</h3>
            <button class="modal-close" data-modal-close>&times;</button>
        </div>
        <div class="modal-body">
            <p class="page-subtitle" style="text-align: center; margin-bottom: 30px;">Ganhe mais visibilidade e destaque-se para os recrutadores!</p>
            
            <div class="premium-plans-container">
                <!-- Plano Mensal -->
                <div class="plan-card">
                    <h4>Plano Mensal</h4>
                    <p class="plan-price">R$ 30<span>/mês</span></p>
                    <ul class="plan-benefits">
                        <li><span class="check-icon">✔</span> Maior visibilidade nas candidaturas</li>
                        <li><span class="check-icon">✔</span> Destaque para recrutadores</li>
                    </ul>
                    <button class="btn btn-secondary select-plan-btn" data-plan="mensal">Selecionar Plano</button>
                </div>

                <!-- Plano Anual (Recomendado) -->
                <div class="plan-card recommended">
                    <div class="recommended-badge">Economize 50%</div>
                    <h4>Plano Anual</h4>
                    <p class="plan-price">R$ 180<span>/ano</span></p>
                    <ul class="plan-benefits">
                        <li><span class="check-icon">✔</span> Maior visibilidade nas candidaturas</li>
                        <li><span class="check-icon">✔</span> Destaque para recrutadores</li>
                    </ul>
                    <button class="btn btn-primary select-plan-btn" data-plan="anual">Selecionar Plano</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let usuario = null; // Será preenchido com os dados da sessão
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('profileForm');
            const fields = form.querySelectorAll('input:not([type="file"]), textarea');
            const fileInput = document.getElementById('curriculo');
            const skillsInput = document.querySelector('#skills.multi-select-input');
            const curriculoLink = document.getElementById('curriculoLink');
            const curriculoDisplay = document.getElementById('curriculoDisplay');
            const editButton = document.getElementById('editButton');
            const profilePicContainer = document.querySelector('.profile-pic-container');
            const profilePicInput = document.getElementById('profilePicInput');
            const profilePicImg = document.getElementById('profilePic');
            const selectedSkillsContainer = document.querySelector('.selected-skills');
            const becomePremiumBtn = document.getElementById('becomePremiumBtn');
            const cancelPremiumBtn = document.getElementById('cancelPremiumBtn');
            const selectPlanBtns = document.querySelectorAll('.select-plan-btn');

            let isEditMode = false;

            // --- Inicializa a página buscando a sessão ---
            async function initializeProfilePage() {
                try {
                    const sessionRes = await fetch('/usuarios/session');
                    if (!sessionRes.ok) {
                        window.location.href = '/login'; // Redireciona se não estiver logado
                        return;
                    }
                    const { user } = await sessionRes.json();
                    usuario = user; // Armazena os dados do usuário globalmente na página
                    await loadProfileData();
                    toggleEditState(); // Set initial readonly state
                } catch (error) {
                    console.error('Erro ao inicializar a página de perfil:', error);
                    window.showNotification('Erro ao carregar sua sessão. Tente fazer login novamente.', 'error');
                }
            }

            // --- Load initial data ---
            async function loadProfileData() {
                try {
                    // Fetch candidate data
                    const candidateRes = await fetch(`/api/candidatos/${usuario.id}`);
                    if (!candidateRes.ok) throw new Error('Candidato não encontrado.');
                    const candidateData = await candidateRes.json();
                    const candidate = candidateData[0];

                    // Populate fields
                    document.getElementById('profileName').textContent = candidate.nome;
                    const joinDate = new Date(candidate.data_cadastro).toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });                    
                    document.getElementById('joinDate').textContent = `Membro desde ${joinDate}`;
                    profilePicImg.src = candidate.foto || '/img/fotos-perfil/candidato-sem-foto.png';

                    document.getElementById('nome').value = candidate.nome;
                    document.getElementById('cpf').value = candidate.cpf;
                    document.getElementById('email').value = candidate.email;
                    document.getElementById('descricao').textContent = candidate.descricao || '';

                    if (candidate.curriculo_link) {
                        curriculoLink.href = `/${candidate.curriculo_link}`;
                        curriculoLink.style.display = 'inline';
                        curriculoLink.textContent = 'Ver currículo atual';
                    } else {
                        curriculoLink.textContent = 'Nenhum currículo enviado.';
                        curriculoLink.removeAttribute('href');
                    }

                    // Fetch and populate skills
                    const skillsRes = await fetch(`/api/habilidades/candidato/${usuario.id}`);
                    if (skillsRes.ok) {
                        const skillsData = await skillsRes.json();
                        if (skillsData.data) {
                            // Use the global function from main.js
                            const multiSelectContainer = document.querySelector('.multi-select-container');
                            window.populateSelectedSkills(multiSelectContainer, skillsData.data, isEditMode);
                        }
                    }

                    await checkPremiumStatus();

                } catch (error) {
                    console.error('Erro ao carregar perfil:', error);
                    window.showNotification('Não foi possível carregar os dados do perfil.', 'error');
                }
            }

            // --- Check Premium Status and Update Buttons ---
            async function checkPremiumStatus() {
                try {
                    const res = await fetch(`usuarios/api/usuarios/${usuario.id}/premium`);
                    const data = await res.json();

                    if (data.premium) {
                        becomePremiumBtn.style.display = 'none';
                        cancelPremiumBtn.style.display = 'block';
                    } else {
                        becomePremiumBtn.style.display = 'block';
                        cancelPremiumBtn.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erro ao verificar status premium:', error);
                    window.showNotification('Não foi possível verificar o status da sua assinatura.', 'error');
                }

                
            }

            // --- Toggle Edit Mode ---
            editButton.addEventListener('click', (e) => {
                e.preventDefault();
                isEditMode = !isEditMode;
                toggleEditState();

                if (!isEditMode) {
                    // If switching from edit to view mode, it means "Salvar" was clicked
                    submitForm();
                }
            });

            function toggleEditState() {
                fields.forEach(field => field.readOnly = !isEditMode);
                curriculoLink.style.display = isEditMode ? 'none' : 'inline';
                fileInput.style.display = isEditMode ? 'block' : 'none';
                skillsInput.disabled = !isEditMode;
                
                // The remove buttons on skill pills need to be re-evaluated every time edit mode changes.
                const removeSkillButtons = selectedSkillsContainer.querySelectorAll('.remove-skill');

                if (isEditMode) {
                    editButton.textContent = 'Salvar Alterações';
                    editButton.classList.remove('btn-primary');
                    editButton.classList.add('btn-secondary');
                    removeSkillButtons.forEach(btn => {
                        btn.style.display = 'inline';
                        // Ensure click event is added only once
                        if (!btn.hasAttribute('data-listener-added')) {
                            btn.addEventListener('click', () => {
                                btn.parentElement.remove();
                            });
                            btn.setAttribute('data-listener-added', 'true');
                        }
                    });
                } else {
                    editButton.textContent = 'Modificar Dados';
                    editButton.classList.add('btn-primary');
                    editButton.classList.remove('btn-secondary');
                    removeSkillButtons.forEach(btn => btn.style.display = 'none');
                }
            }

            // --- Profile Picture Upload ---
            profilePicContainer.addEventListener('click', () => profilePicInput.click());
            profilePicInput.addEventListener('change', async () => {
                const file = profilePicInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('id_usuario', usuario.id);
                formData.append('foto', file);

                try {
                    const res = await fetch(`/usuarios/atualizar-foto`, {
                        method: 'PATCH',
                        body: formData
                    });

                    const result = await res.json();
                    if (res.ok) {
                        profilePicImg.src = `/${result.foto_url}`;
                        window.showNotification('Foto de perfil atualizada com sucesso!');
                        // Atualiza a UI (incluindo a navbar) com os novos dados da sessão
                        window.updateUIAfterLogin(result.user);
                    } else {
                        throw new Error(result.message || 'Falha ao atualizar a foto.');
                    }
                } catch (error) {
                    console.error('Erro no upload da foto:', error);
                    window.showNotification(`Falha ao salvar foto: ${error.message}`, 'error');
                }
            });

            // --- Form Submission ---
            async function submitForm() {
                const id_candidato = usuario.id;
                const promises = [];

                // 1. Update Textual Data (nome, email, descricao)
                const textData = {
                    id_candidato: id_candidato,
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    cpf: document.getElementById('cpf').value, // CPF is readonly, but good to send
                    descricao_pessoal: document.getElementById('descricao').value
                };

                promises.push(fetch('/api/candidatos/atualizar-candidato', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(textData)
                }));

                // 2. Update Skills
                const skillIds = Array.from(selectedSkillsContainer.children)
                                     .map(pill => pill.getAttribute('data-skill-id'));
                
                const skillsData = {
                    id_candidato: id_candidato,
                    habilidades: skillIds
                };

                promises.push(fetch('/api/candidatos/atualizar-habilidades', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(skillsData)
                }));

                // 3. Update Curriculum (if a new one was selected)
                const curriculoFile = fileInput.files[0];
                if (curriculoFile) {
                    const curriculoFormData = new FormData();
                    curriculoFormData.append('id_candidato', id_candidato);
                    curriculoFormData.append('curriculo', curriculoFile);

                    promises.push(fetch('/api/candidatos/atualizar-curriculo', {
                        method: 'PATCH',
                        body: curriculoFormData
                        // No 'Content-Type' header for FormData, browser sets it with boundary
                    }));
                }

                try {
                    const results = await Promise.all(promises);

                    // Check if any of the requests failed
                    const failedRequest = results.find(res => !res.ok);
                    if (failedRequest) {
                        const errorData = await failedRequest.json();
                        throw new Error(errorData.error || 'Uma das atualizações falhou.');
                    }

                    window.showNotification('Dados atualizados com sucesso!');
                    loadProfileData(); // Reload data to show all changes
                } catch (error) {
                    console.error('Erro ao salvar alterações:', error);
                    window.showNotification(`Falha ao salvar: ${error.message}`, 'error');
                    // Revert button to edit state if save fails
                    isEditMode = true; 
                    toggleEditState();
                }
            }

            // --- Premium Functionality ---
            async function becomePremium() {
                try {
                    const res = await fetch(`usuarios/api/usuarios/${usuario.id}/tornar-premium`, {
                        method: 'PATCH'
                    });

                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(errorData.error || 'Falha ao ativar o plano Premium.');
                    }

                    // Close modal
                    const premiumModal = document.getElementById('premiumModalCandidato');
                    closeModal(premiumModal);

                    window.showNotification('Parabéns! Agora você é um usuário Premium', 'success');
                    await checkPremiumStatus(); // Refresh buttons

                } catch (error) {
                    console.error('Erro ao tornar-se premium:', error);
                    window.showNotification(`Falha ao ativar plano: ${error.message}`, 'error');
                }
            }

            async function cancelPremium() {
                const confirmed = await window.showConfirmationDialog('Tem certeza que deseja cancelar sua assinatura Premium? Sua visibilidade para recrutadores será reduzida.');

                if (confirmed) {
                    try {
                        const res = await fetch(`usuarios/api/usuarios/${usuario.id}/remover-premium`, {
                            method: 'PATCH'
                        });

                        if (!res.ok) {
                            const errorData = await res.json();
                            throw new Error(errorData.error || 'Falha ao cancelar a assinatura.');
                        }

                        window.showNotification('Sua assinatura Premium foi cancelada', 'success');
                        await checkPremiumStatus(); // Refresh buttons

                    } catch (error) {
                        console.error('Erro ao cancelar premium:', error);
                        window.showNotification(`Falha ao cancelar: ${error.message}`, 'error');
                    }
                }
            }

            function closeModal(modal) {
                if (modal == null) return;
                const backdrop = document.getElementById('modalBackdrop');
                if (backdrop) backdrop.classList.remove("show");
                modal.classList.remove("show");
            }

            // Initial Load
            initializeProfilePage();

            selectPlanBtns.forEach(btn => btn.addEventListener('click', becomePremium));
            cancelPremiumBtn.addEventListener('click', cancelPremium);
        });
    </script>
</body>
</html>